#!/bin/sh

TMPFILE="temp.out"
KNOWN_FAILURES="known_failures.txt"
CORRECT_DIR="correct_output"

TEST_NUMS="001 002 003 004 005 006 007 008 009 010 011 012 013 014 \
016 017 018 019 020 021 022 023 024 025 026 028 030 031 032 033 034 \
035 036 037 038 039 040 041 042 043 044 045 050 056 060 061 062 080 \
097 098 099 100 101 102 103 104 105 106 107 108 109 110 111 200 201 \
202 203 204 205 251 252 253 254 255 256 257 258 259 260 261 300 301 \
302 306 307 308 311 317 328 351 352 353 354 355 356 357 359 360 361 \
362 363 364 368 369 370 371 372 373 374 375 376 377 378 379 401 402 \
403 404 405 406 407 411 413 500 503 506 509 514 517 520 700 701 710 "

ALL_TEST_NUMS="001 002 003 004 005 006 007 008 009 010 011 012 013 014 \
016 017 018 019 020 021 022 023 024 025 026 028 030 031 032 033 034 \
035 036 037 038 039 040 041 042 043 044 045 050 056 060 061 062 080 \
097 098 099 100 101 102 103 104 105 106 107 108 109 110 111 200 201 \
202 203 204 205 251 252 253 254 255 256 257 258 259 260 261 300 301 \
302 306 307 308 311 317 328 351 352 353 354 355 356 357 359 360 361 \
362 363 364 368 369 370 371 372 373 374 375 376 377 378 379 401 402 \
403 404 405 406 407 411 413 500 503 506 509 514 517 520 700 701 710 \
711 715 718 719 722 800 801 802 803 804 805 806 807 808 809 810 811 \
812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 \
829 830 831 832 833 834 900 901 903 905 906 907 908 909 910 912 914 \
915 916 917 919 920 921 922 923"

NUM_UNEXPECTED_FAILURES=0
NUM_KNOWN_FAILURES=0
NUM_PASS=0

for testcase in ${TEST_NUMS}; do
  FAIL=0
  echo -n "$testcase --"
  /bin/rm -f ${TMPFILE}
  if make TEMP_OUT="${TMPFILE}" test${testcase} >& /dev/null; then
    foo=`diff ${TMPFILE} ${CORRECT_DIR}/FM${testcase}.out.correct`
    if [ "$foo" != "" ]; then
      FAIL=1
    else
      echo " passed"
      NUM_PASS=`expr ${NUM_PASS} + 1`
    fi
  else
    FAIL=1
  fi

  if [ $FAIL == "1" ]; then
    if grep ${testcase} ${KNOWN_FAILURES} >/dev/null ; then
      grep ${testcase} ${KNOWN_FAILURES} | cut -d- -f 2-
      NUM_KNOWN_FAILURES=`expr ${NUM_KNOWN_FAILURES} + 1`
    else
      echo " FAILED"
      NUM_UNEXPECTED_FAILURES=`expr ${NUM_UNEXPECTED_FAILURES} + 1`
    fi
  fi
done

echo "Number of tests passed:              ${NUM_PASS}"
echo "Number of tests failed (expected):   ${NUM_KNOWN_FAILURES}"
echo "Number of tests failed (unexpected): ${NUM_UNEXPECTED_FAILURES}"

/bin/rm -f ${TMPFILE}

if [ ${NUM_UNEXPECTED_FAILURES} != "0" ]; then
  RV=1
else
  RV=0
fi

exit ${RV}
