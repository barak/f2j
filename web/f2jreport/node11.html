<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<!--Converted with LaTeX2HTML 96.1 (Feb 5, 1996) by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds -->
<HTML>
<HEAD>
<TITLE>GOTO Translation</TITLE>
<META NAME="description" CONTENT="GOTO Translation">
<META NAME="keywords" CONTENT="f2jreport">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<LINK REL=STYLESHEET HREF="f2jreport.css">
</HEAD>
<BODY LANG="EN">
 <A NAME="tex2html203" HREF="node12.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/next_motif.gif"></A> <A NAME="tex2html201" HREF="node3.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/up_motif.gif"></A> <A NAME="tex2html195" HREF="node10.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/previous_motif.gif"></A>   <BR>
<B> Next:</B> <A NAME="tex2html204" HREF="node12.html">The Need for Code </A>
<B>Up:</B> <A NAME="tex2html202" HREF="node3.html">Translating LAPACK FORTRAN to </A>
<B> Previous:</B> <A NAME="tex2html196" HREF="node10.html">Methods versus functions and </A>
<BR> <P>
<H3><A NAME="SECTION00021800000000000000">GOTO Translation</A></H3>
<P>
It is preferable to translate F<font size=-1><small>ORTRAN</small></font> programs to Java
source code rather than Jasmin opcode for many reasons,
but there has been a major obstacle to doing this: the
GOTO statement.  The F<font size=-1><small>ORTRAN</small></font> GOTO is hard to translate
to Java source code because Java does not support a <TT>goto</TT>
statement at all.  The developers of the Java language deliberately
omitted the <TT>goto</TT> statement because they felt it would
simplify the language and eliminate some common misuses of
the <TT>goto</TT> [<A HREF="node35.html#java_lang">10</A>].  Their replacement for the
<TT>goto</TT> includes the multi-level <TT>break</TT> and <TT>continue</TT>
statements.  This section describes our approach to translating
F<font size=-1><small>ORTRAN</small></font> to Java source code while still allowing the use of
GOTOs.
<P>
For our purposes, a GOTO statement in F<font size=-1><small>ORTRAN</small></font> falls into one of
two categories: (1) one that can be translated into an equivalent Java
construct free of GOTOs (such as <TT>while</TT>, <TT>break</TT>, <TT>continue</TT>, etc.)
or (2) one that cannot be translated into such a construct.
<P>
First, we examine some examples from the first category.
The following segment of code from dlamch.f shows a simulated
while loop written using an IF statement and a GOTO.
<PRE>   10    CONTINUE
         IF( C.EQ.ONE ) THEN
            A = 2*A
            C = DLAMC3( A, ONE )
            C = DLAMC3( C, -A )
            GO TO 10
         END IF</PRE>
<P>
To recognize this type of construct, f2j looks for two characteristics:
(1) an IF statement with a labeled CONTINUE preceding it and (2) a GOTO
statement at the end of the IF block whose target is the top of the
IF block.  Nested simulated while loops are recognized
by pushing the label of the most enclosing IF block on a stack and 
comparing the destination of an enclosed GOTO with that label.  The label
is then popped off after emitting the IF block.  The Java translation for
the above loop would be:
<PRE>  while (c == one)  {
    a = 2*a;
    c = Dlamc3.dlamc3(a,one);
    c = Dlamc3.dlamc3(c,-a);
  }              // Close if()</PRE>
<P>
Frequently F<font size=-1><small>ORTRAN</small></font> programs contain GOTO statements within DO loops.
This includes many different situations, but we may roughly categorize
them as follows:
<UL><LI> The GOTO branches to the CONTINUE statement of this DO loop.<LI> The GOTO branches to the CONTINUE statement of some other enclosing DO loop.<LI> The GOTO branches to the statement following this DO loop.<LI> The GOTO branches to the statement following some other enclosing DO loop.<LI> The GOTO branches somewhere else (this equates to the second category of GOTO
statements as described above).
</UL>
<P>
The first two cases correspond to Java's <TT>continue</TT> and labeled <TT>continue</TT>
respectively.  In Java, the labeled <TT>continue</TT> is used in cases where
there are multiple nested loops and the programmer needs to distinguish
which loop to continue.  The following code segment from idamax.f
shows a GOTO that can be translated to a Java <TT>continue</TT> statement.
<PRE>      do 30 i = 2,n
         if(dabs(dx(i)).le.dmax) go to 30
         idamax = i
         dmax = dabs(dx(i))
   30 continue</PRE>
<P>
Detecting this kind of construct is similar to detecting a simulated while
loop.  Each time f2j starts generating a loop, the label of that loop's 
CONTINUE statement is pushed onto a stack.  Then when a GOTO is encountered,
f2j examines the stack to determine if the GOTO is branching to the 
CONTINUE statement of an enclosing DO loop.
The difference between translating continue statements and
simulated while statements is that with continue statements, we need to examine 
all labels on the stack, not just the top.
Notice in the following Java translation that even though we could have
generated an unlabeled <TT>continue</TT> statement, we chose to generate
labeled <TT>continue</TT> statements in all cases to help ensure clarity.
<PRE>  forloop30:
  for (i = 2; i &lt;= n; i++) {
    if (Math.abs(dx[(i)- 1]) &lt;= dmax)
      continue forloop30;
    idamax = i;
    dmax = Math.abs(dx[(i)- 1]);
  }              //  Close for() loop.</PRE>
<P>
The third and fourth cases from above correspond to Java's <TT>break</TT>
and labeled <TT>break</TT> respectively.  f2j does not currently detect
or translate these cases, but they would be handled very similarly to
the translation of continue statements.  The main exception is that
labeled <TT>break</TT> statements in Java may ``break out'' of any 
enclosing statement, while labeled <TT>continue</TT> statements are
restricted to loops (<TT>while</TT>, <TT>for</TT>, or <TT>do</TT>).
Thus, there may be a much wider range of constructs in which a GOTO 
can be converted to a labeled <TT>break</TT>.
The following segment of code is a modified version of the previous
segment from idamax.f in which the GOTO now branches to the statement
following the DO loop.
<PRE>      do 40 i = 2,n
        if(dabs(dx(i)).le.dmax) go to 50
        idamax = i
        dmax = dabs(dx(i))
  40  continue
  50  a = 1</PRE>
<P>
Future versions of f2j will translate the ``go to 50'' to a
<TT>break</TT> statement.
<P>
The final case from the above list (that is, the GOTO branches
somewhere else) has been the most difficult to
deal with - it does not correspond to any equivalent
Java construct.  Our goal is to restructure as
many F<font size=-1><small>ORTRAN</small></font> constructs containing GOTOs as possible into
equivalent Java constructs.  But there will always be some GOTOs
that cannot be translated in this way.  To handle these cases, we have
developed a method to insert GOTO statements into Java bytecode
(see figure <A HREF="node11.html#goto_fig">1</A>).
<P>
<P><A NAME="159">&#160;</A><A NAME="goto_fig">&#160;</A> <IMG WIDTH=333 HEIGHT=573 ALIGN=BOTTOM ALT="figure159" SRC="img2.gif"  > <BR>
<STRONG>Figure 1:</STRONG> Translation of GOTO statements<BR>
<P>
<P>
First, we use f2java to translate the F<font size=-1><small>ORTRAN</small></font> code to Java.  
GOTOs are automatically translated as calls to a dummy 
class.  So, <TT>go to 100</TT> would be translated as 
<TT>Dummy.go_to(100)</TT>.  The labels in the F<font size=-1><small>ORTRAN</small></font> source
are also translated as calls
to the dummy class (for example,  the label <TT>100</TT> becomes 
<TT>Dummy.label(100)</TT> in the Java source).
<P>
Next we compile the java file as usual (using javac).
<P>
At this point, we could run the resulting class file (bytecode),
but instead of branching, the Dummy methods would be called.
The program would, almost invariably, run incorrectly.
The dummy calls act only as placeholders in the bytecode to signify 
where <I>real</I> goto instructions should be inserted.  We have
developed a bytecode translation tool to perform these insertions.  
Since JVM instructions have variable widths (and for other reasons),
we must parse the class file in order to identify the dummy method calls.
For this, we borrowed parsing code from <TT>javab</TT>, a bytecode parallelizing
tool [<A HREF="node35.html#javab">11</A>].  After the bytecode has been parsed, we scan it for
calls to <TT>Dummy.label()</TT>, recording the label and address in a hash table.
We then zero the entire instruction sequence for the method call so that the
resulting bytecode does not attempt to call <TT>Dummy.label()</TT> (in the JVM,
a zero byte corresponds to the <TT>nop</TT> instruction - i.e., it does nothing).
On the second pass, we scan for calls to <TT>Dummy.go_to()</TT>.  For each
call, we look up the target label of the goto in the hash table to obtain
the actual bytecode address of the label.  Then we may replace the <TT>Dummy.go_to()</TT>
method invocation with an actual <TT>goto</TT> instruction.  Since the method
invocation instruction sequence is longer than the goto instruction, we
zero out the remaining bytes.
<P>
So far, this method has been successful in translating GOTO
statements in the BLAS/LAPACK source code and testing routines.  
There may be some
cases in which ``hacking'' the compiler-produced bytecode
as we have done will produce unexpected results, possibly
putting the JVM into an unusual state.  The Java compiler 
generates code under certain
assumptions, one example of which is that the program should not
branch to a statement within a loop from outside the loop.  
Our GOTO translation method has the potential to violate 
these assumptions, although we have not yet come across a 
specific instance in the BLAS or LAPACK source.
<P>
<HR><A NAME="tex2html203" HREF="node12.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/next_motif.gif"></A> <A NAME="tex2html201" HREF="node3.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/up_motif.gif"></A> <A NAME="tex2html195" HREF="node10.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/previous_motif.gif"></A>   <BR>
<B> Next:</B> <A NAME="tex2html204" HREF="node12.html">The Need for Code </A>
<B>Up:</B> <A NAME="tex2html202" HREF="node3.html">Translating LAPACK FORTRAN to </A>
<B> Previous:</B> <A NAME="tex2html196" HREF="node10.html">Methods versus functions and </A>
<P><ADDRESS>
<I>Keith Seymour <BR>
Wed Jun 10 19:38:14 EDT 1998</I>
</ADDRESS>
</BODY>
</HTML>
