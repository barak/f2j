<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<!--Converted with LaTeX2HTML 96.1 (Feb 5, 1996) by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds -->
<HTML>
<HEAD>
<TITLE>The Need for Code Restructuring</TITLE>
<META NAME="description" CONTENT="The Need for Code Restructuring">
<META NAME="keywords" CONTENT="f2jreport">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<LINK REL=STYLESHEET HREF="f2jreport.css">
</HEAD>
<BODY LANG="EN">
 <A NAME="tex2html213" HREF="node13.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/next_motif.gif"></A> <A NAME="tex2html211" HREF="node3.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/up_motif.gif"></A> <A NAME="tex2html205" HREF="node11.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/previous_motif.gif"></A>   <BR>
<B> Next:</B> <A NAME="tex2html214" HREF="node13.html">DATA Statements</A>
<B>Up:</B> <A NAME="tex2html212" HREF="node3.html">Translating LAPACK FORTRAN to </A>
<B> Previous:</B> <A NAME="tex2html206" HREF="node11.html">GOTO Translation</A>
<BR> <P>
<H3><A NAME="SECTION00021900000000000000">The Need for Code Restructuring</A></H3>
<P>
Even though we now have a way to translate any arbitrary
GOTO statement into Java source, there is still another
problem caused by Java's lack of a <TT>goto</TT> statement.
Consider the following segment of code from ddot.f:
<PRE>      if(incx.eq.1.and.incy.eq.1)go to 20
c
      [...code for unequal increments...]
c
      ddot = dtemp
      return
c
c        code for both increments equal to 1
c
   20 m = mod(n,5)</PRE>
<P>
The first line of code checks whether both increments are
equal to 1 and if so, skips the section of code to deal
with unequal increments.  We can see by looking at the
F<font size=-1><small>ORTRAN</small></font> code (and so can the F<font size=-1><small>ORTRAN</small></font> compiler) that statement
20 can be reached.  However, looking at the Java source
code produced by f2j, it is easy to see why the Java compiler does not
recognize that fact:
<P>
<PRE>  if (incx == 1 &amp;&amp; incy == 1)
    Dummy.go_to(&quot;Ddot&quot;,20);

  [...code for unequal increments...]

  ddot = dtemp;
  return ddot;

  Dummy.label(&quot;Ddot&quot;,20);
  m = (n)%(5) ;</PRE>
<P>
When the Java compiler analyzes this program, it views the call
to <TT>Dummy.go_to</TT> as a normal method call.  So, as far as javac
is concerned, execution resumes with the code immediately following
the method call.  Since the segment of code following the method
call ends with a <TT>return</TT> statement, javac determines that any
statements following the <TT>return</TT> cannot be reached.  Normally
this would be a perfectly reasonable determination, but in this case
we know that the call to <TT>Dummy.go_to</TT> will really cause the
program to branch to statement 20.
<P>
Currently, there are a few ways to handle this.  We could manually change
the F<font size=-1><small>ORTRAN</small></font> source code such that the IF expression is reversed
and put the equal increments code ahead of the unequal increments
code.  There are code restructuring tools that can recognize
and restructure these constructs automatically, removing the GOTO
in the process.  We could restructure the Java source code after
translation (not a great idea).  Future versions of f2j may have some
code restructuring ability built in, so that they can generate correct
Java source code without the need for manual restructuring or external
tools.  Our current approach is to generate one ``real'' <TT>return</TT>
statement at the end of the function or subroutine, with a unique
label.  All other <TT>return</TT> statements
are translated into dummy gotos, with the target being the ``real''
<TT>return</TT>.  Using this approach, the java compiler views all return
statements as function calls, so it no longer thinks that subsequent 
statements cannot be reached.  This approach is much simpler and less
error-prone than code restructuring.
<P>
<HR><A NAME="tex2html213" HREF="node13.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/next_motif.gif"></A> <A NAME="tex2html211" HREF="node3.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/up_motif.gif"></A> <A NAME="tex2html205" HREF="node11.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/previous_motif.gif"></A>   <BR>
<B> Next:</B> <A NAME="tex2html214" HREF="node13.html">DATA Statements</A>
<B>Up:</B> <A NAME="tex2html212" HREF="node3.html">Translating LAPACK FORTRAN to </A>
<B> Previous:</B> <A NAME="tex2html206" HREF="node11.html">GOTO Translation</A>
<P><ADDRESS>
<I>Keith Seymour <BR>
Wed Jun 10 19:38:14 EDT 1998</I>
</ADDRESS>
</BODY>
</HTML>
