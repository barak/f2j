<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<!--Converted with LaTeX2HTML 96.1 (Feb 5, 1996) by Nikos Drakos (nikos@cbl.leeds.ac.uk), CBLU, University of Leeds -->
<HTML>
<HEAD>
<TITLE>Functions as Arguments</TITLE>
<META NAME="description" CONTENT="Functions as Arguments">
<META NAME="keywords" CONTENT="f2jreport">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<LINK REL=STYLESHEET HREF="f2jreport.css">
</HEAD>
<BODY LANG="EN">
 <A NAME="tex2html301" HREF="node22.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/next_motif.gif"></A> <A NAME="tex2html299" HREF="node3.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/up_motif.gif"></A> <A NAME="tex2html295" HREF="node20.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/previous_motif.gif"></A>   <BR>
<B> Next:</B> <A NAME="tex2html302" HREF="node22.html">Implemention of the f2j </A>
<B>Up:</B> <A NAME="tex2html300" HREF="node3.html">Translating LAPACK FORTRAN to </A>
<B> Previous:</B> <A NAME="tex2html296" HREF="node20.html">Type Analysis</A>
<BR> <P>
<H3><A NAME="SECTION000211800000000000000">Functions as Arguments</A></H3>
<P>
F<font size=-1><small>ORTRAN</small></font> allows passing the name of a function or subroutine as an
argument to another function or subroutine.  In Java, however,
passing a method as an argument is not possible.  The recommended
way to achieve the same effect in Java is by using <I>interfaces</I>.  
The prototype of the method to be passed is placed in an
interface.  The data type of the parameter in the called method should be 
the name of the interface.  The method to be passed must be in
a class that implements the interface.
<P>
The problem with using this approach in f2j-generated code is
one of naming.  When compiling a function that takes another
function as a parameter, f2j does not know the name of the
original function, only the name of the local parameter.
So f2j cannot decide how to call the method.
<P>
Instead of using interfaces, we chose to use the <I>reflection</I>
mechanism built into version 1.1 of the Java language.  Reflection
allows a Java program to discover information about an object (such as public
methods and public class variables) at run-time.  The first method
in all f2j-generated classes is the translated F<font size=-1><small>ORTRAN</small></font> routine.
After that, the only other methods that should be contained in
the class are adapters (see section <A HREF="node19.html#adapter">2.1.16</A>).  Therefore, the
generated Java code can get a reference to the 
correct method by simply using reflection to access 
the first method in the class.
<P>
With this technique, the code in the calling method is simple.
The user just passes a new instance of the class containing the
method:
<PRE>    Sort.sort(x, 0, new Comp() );</PRE>
It is necessary to create a new instance of the class because
reflection requires a reference to the object.
All methods in f2j-generated classes are static and normally there
is not already an instance of the class, so we create one on-the-fly.
<P>
The code in the called method is a little more complex since
it has to perform the reflection.  First, the routine gets a
reference to the method:
<PRE>public static void sort (int [] a, int _a_offset, Object cfun)  {

  java.lang.reflect.Method _cfun_meth = cfun.getClass().getDeclaredMethods()[0];</PRE>
Note that the data type of the class is <TT>Object</TT> because
f2j does not know what kind of object is going to be passed in.
Before calling the method, the arguments must be placed into
an array of <TT>Object</TT>.  Since this may take several statements
and the original call may be embedded in some construct like a
conditional expression, f2j generates an adapter function.
The first argument to the adapter is the reference to the method.
The remaining arguments mirror the parameters of the original
function.
<PRE>if(cfun_methcall(_cfun_meth,a[(i)- 1+ _a_offset],a[(j)- 1+ _a_offset]) &gt; 0)</PRE>
Then the adapter makes the actual call:
<P>
<PRE>  private static int cfun_methcall( java.lang.reflect.Method _funcptr, 
   int _arg0 , int _arg1 )
     throws java.lang.reflect.InvocationTargetException,
            java.lang.IllegalAccessException
  {
    Object [] _funcargs = new Object [2];
    int _retval;

    _funcargs[0] = new Integer(_arg0);
    _funcargs[1] = new Integer(_arg1);

    _retval = ( (Integer) _funcptr.invoke(null,_funcargs)).intValue();

    return _retval;
  }</PRE>
<P>
<HR><A NAME="tex2html301" HREF="node22.html"><IMG WIDTH=37 HEIGHT=24 ALIGN=BOTTOM ALT="next" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/next_motif.gif"></A> <A NAME="tex2html299" HREF="node3.html"><IMG WIDTH=26 HEIGHT=24 ALIGN=BOTTOM ALT="up" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/up_motif.gif"></A> <A NAME="tex2html295" HREF="node20.html"><IMG WIDTH=63 HEIGHT=24 ALIGN=BOTTOM ALT="previous" SRC="http://www.cs.utk.edu/~icl/WebSite/icons/previous_motif.gif"></A>   <BR>
<B> Next:</B> <A NAME="tex2html302" HREF="node22.html">Implemention of the f2j </A>
<B>Up:</B> <A NAME="tex2html300" HREF="node3.html">Translating LAPACK FORTRAN to </A>
<B> Previous:</B> <A NAME="tex2html296" HREF="node20.html">Type Analysis</A>
<P><ADDRESS>
<I>Keith Seymour <BR>
Wed Jun 10 19:38:14 EDT 1998</I>
</ADDRESS>
</BODY>
</HTML>
